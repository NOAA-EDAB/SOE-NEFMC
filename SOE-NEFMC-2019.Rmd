---
title: "null"
csl: plos.csl
fontsize: 10pt
output:
  pdf_document:
    latex_engine: xelatex
    includes:
      in_header: latex/header.tex
    keep_tex: yes
  html_document:
    df_print: paged
link-citations: yes
geometry: left=2cm, right=2cm, top=2cm, bottom=3cm, footskip = .5cm
subparagraph: yes
bibliography: SOE2019.bib
---

```{r setup, include=FALSE}

# library(tint)
# # invalidate cache when the package version changes
# knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tint'))
# options(htmltools.dir.version = FALSE)

#Default Rmd options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      dev = "cairo_pdf",
                      warning = FALSE,
                      fig.align = 'center') #allows for inserting R code into captions

#Plotting and data libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ecodata)
library(here)
library(kableExtra)
library(ggrepel)
library(stringr)
library(patchwork)
library(grid)
# library(ggiraph)
library(vegan)
library(RColorBrewer)
library(rpart)

#GIS libraries
library(sf)
library(rgdal)
library(raster)
library(rnaturalearth)

#Data directories
image.dir <- here("images")
gis.dir <- here("gis")

#GIS directory
#gis.dir <- here::here("inst","extdata","gridded")

#General inline text input for report
#Council
council <- "New England Fishery Management Council"
council_abbr <- "NEFMC"

#Region identifiers
epu <- "New England"
epu_abbr <- c("GOM","GB")
region <- "New England"
region_abbr <- "NE" #Some commercial data organized by "MA" or "NE" regions, not by EPU 


```


```{r GIS-setup}

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Coastline shapefile   
coast <- ne_countries(scale = 10,
                          continent = "North America",
                          returnclass = "sf") %>%
             sf::st_transform(crs = crs)

#State polygons
ne_states <- ne_states(country = "united states of america",
                                      returnclass = "sf") %>%
  sf::st_transform(crs = crs)

#high-res polygon of Maine
#new_england <- read_sf(gis.dir,"new_england")

#EPU shapefile
epu_sf <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB","GB","GOM"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -77
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#Time series constants
shade.alpha <- 0.3
shade.fill <- "lightgrey"
lwd <- 1
pcex <- 2
trend.alpha <- 0.5
trend.size <- 2
hline.size <- 1
hline.alpha <- 0.35
hline.lty <- "dashed"
label.size <- 5
hjust.label <- 1.5
letter_size <- 4
feeding.guilds <- c("Apex Predator","Piscivore","Planktivore","Benthivore","Benthos")
x.shade.min <- 2009
x.shade.max <- 2018
#Function for custom ggplot facet labels
label <- function(variable,value){
  return(facet_names[value])
}
```

# Overview
The purpose of this report is to synthesize available information relevant to fishery management in the New England portion of the US Northeast Shelf (the Gulf of Maine, GOM, and Georges Bank, GB). This 2019 report highlights where management interventions have proven successful to achieve ecological objectives, but also characterizes the considerable challenges for management posed by climate change and increasing trade-offs across conservation, fishing, and other human activities in this region (Fig. \ref{fig:conceptual-model}). Finally, we describe combinations of ecological signals that present opportunities for further integrated research and possibly creative management solutions. 

```{r conceptual-model, echo=FALSE, out.width = "\\textwidth", fig.cap="A conceptual model places detailed species-level management in context by highlighting relationships between focal species groups organized by the New England Fishery Management Council (NEFMC) Fishery Management Plan (FMP), managed human activities, environmental drivers, habitats, and key ecological links."}

knitr::include_graphics("images/GOM_GB_conmod_overview.jpg")
```

Some management interventions for ecosystems and fisheries have proven beneficial in New England and throughout the Northeast US Shelf. For example, harbor porpoise bycatch continues to decrease. The 2016 and 2017 harbor porpoise bycatch estimates are among the lowest on record in the Northeast US (Fig. \ref{fig:harbor-porpoise-bars}), coinciding with an apparently stablized harbor porpoise population.

However, there are multiple signals indicating challenges to meeting management goals. Fishery management objectives are being met for 20 stocks at the single species level, but 9 stocks are below biomass thresholds (Fig. \ref{fig:NE-stock-status}). Both New England social-ecological systems are reliant on a single species for the majority of revenue (lobster in GOM, scallop in GB). These species have moderate to high climate vulnerability, likely representing heightened risk to fishing communities, particularly along the coast of Maine and the South Coast of Massachusetts where ports are highly engaged and reliant on commercial fishing (Fig. \ref{fig:NE-comm-reliance-maps-outlined}). There are long term declines in total seafood production and commercial revenue for New England-managed species in the GOM (Figs. \ref{fig:comm-landings-ne}, \ref{fig:total-landings-ne}, \ref{fig:comm-revenue-ne}). However, indicators highlight an increasing diversity of recreational species caught in New England (Fig. \ref{fig:rec-div}).

Fisheries are significantly affecting protected species, particularly large whale abundance. Changes in fishery management to address this issue could have considerable consequences for the fixed gear fishing sector, particularly for pot gear such as for lobster. The recovery of north Atlantic right whales is affected by anthropogenic mortality (Fig. \ref{fig:NARW-abundance}). Shifts in ecosystem conditions may be contributing to increased interaction between right whales and fishing gear and could be playing a role in other protected species trends. Unusual Mortality Events (UMEs) have been declared for north Atlantic right whales, humpback whales, and minke whales, and preliminary investigations suggest fishing gear entanglement has played a primary role in these mortalities. Gray seal bycatch mortality has also risen in recent years, with an estimated annual mortality that has often totaled more than 1000 animals and a UME has been declared for both gray and harbor seals that may be due to phocine distemper virus. 

Several climate and ecosystem observations are trending towards or have reached unprecedented levels. The Northeast US shelf is among the fastest warming waters globally (Fig. \ref{fig:long-term-sst}) with implications for species physiology, productivity, distribution, and community composition. Globally, 2018 was the 4th warmest year on record with the last four years being the warmest on record. In both the GOM and GB, 2018 seasonal sea surface temperatures were above average, while while the summer temperatures in the Gulf of Maine were the highest on record (Fig. \ref{fig:NE-SST-anom-series}). Annual average bottom temperature measurements show a significant long term warming trend in the GOM (Fig. \ref{fig:NE-bot-temp}). Ocean circulation is changing as well. The position of the northern edge of the Gulf Stream has trended northward since the late 1950s, with an increasing rate since 2009. The most northerly positions on record were observed between 2014-2017 (Fig. \ref{fig:GSI}). Since the mid-2000'??s, the warmer, saltier shelf slope water associated with the Gulf Stream has dominated the input into the GOM at the Northeast Channel (Fig. \ref{fig:wsw-prop}). A more northerly Gulf Stream position is generally associated with warmer ocean temperature in the Northeast US shelf [@zhang_role_2007] and increased sea surface height along the U.S. east coast [@goddard_extreme_2015]. 

The management implications of these ocean changes vary by region and species, and are not fully understood at this point. Changes in the distribution of managed fish species continue, with aggregate trends on the entire Northeast Shelf shifting towards the northeast and generally into deeper water (Fig. \ref{fig:spec-dist}). These shifts place increasing pressure on the management system. The proportion of NEFMC managed benthivore species (righteye flounders, haddock) has declined over time in Mid-Atlantic waters according to bottom trawl surveys (Fig. \ref{fig:NEFMC-in-MAB}), while the proportion of MAFMC managed planktivore (squids, mackerel, and butterfish) species has been increasing in New England waters in both surveys and landings (Figs. \ref{fig:MAFMC-in-NE}, \ref{fig:comm-landings-ne}). Butterfish have been observed in Gulf of Maine common tern fledgling diets between 2009-2011 and again in 2018 (Fig. \ref{fig:map-and-prey}b), which negatively impacts tern productivity. The downward trend in recreational species diversity in the Mid-Atlantic (see Mid-Atlantic report) contrasts with an increase in recreational species diversity over time in New England (Fig. \ref{fig:rec-div}), although it is unclear to what extent this result is due to the aggregation of SAFMC species in the indicator itself. Nearshore MA and ME/NH survey indices show some similar patterns to offshore surveys, although with different magnitudes, perhaps reflecting seasonal importance of nearshore habitats (Figs. \ref{fig:gom-biomass-ne},  \ref{fig:MA-inshore}, \ref{fig:menh-survey}); these patterns will be explored in more detail in future analyses. As temperature and ocean circulation indicators trend toward extremes, fishery management based on static stock areas will likely face continued changes in species distribution.

Observed changes at the base of the food web, including timing and community composition, affect productivity of protected and managed species in ways we do not yet fully understand. There is a trend of increasing primary production in New England, but this trend is primarily driven by increased summer production, which is due to warmer temperatures and increased bacterial remineralization and nutrient recycling (Fig. \ref{fig:NE-PP-OCCI}). This increased productivity is most likely from smaller-celled species that contribute less to fish production compared to larger phytoplankton. Current zooplankton trends show a shift towards smaller-bodied copepods (Fig. \ref{fig:NE-sli}). This suggests a possible return to conditions last observed during the 1990s, when small bodied copepods dominated the zooplankton community, regime shifts in groundfish recruitment were observed [@perretti_regime_2017], and north Atlantic right whales experienced lower birth rates [@greene_remote_2013]. The timing of shifts in fish condition may be similar (Fig. \ref{fig:ne-cf}), though potential mechanisms connecting adult fish condition to zooplankton patterns require further study.

# Report Structure

The major messages of the report are synthesized above with reference to key figures. The information in this report is organized around general ecosystem-level management objectives (Table \ref{tab:management-objectives}), and indicators related to these objectives are grouped into four general categories in the four sections below: economic and social, protected species, fish and invertebrates, and habitat quality and ecosystem productivity. Each section begins with a summary of main messages with links to other sections, including any new information added at the request of the Council, and includes figures with brief descriptions of all current indicators. Detailed technical methods documentation^[https://NOAA-EDAB.github.io/tech-doc] and indicator data^[https://github.com/NOAA-EDAB/ecodata] are available online. The details of standard figure formatting (Fig. \ref{fig:docformat}a), categorization of fish and invertebrate species into feeding groups (Table \ref{tab:species-groupings}), and definitions of ecological production units (EPUs, including the Gulf of Maine (GOM) and Georges Bank (GB); Fig. \ref{fig:docformat}b) are provided at the end of the document.

```{r management-objectives}

mng_obj <- data.frame("Objective Categories" = c("Seafood Production",
                                                 "Profits","Recreation",
                                                 "Stability","Social & Cultural",
                                                 "Biomass","Productivity",
                                                 "Trophic structure","Habitat"),
                      "Indicators reported here" = c("Landings by feeding guild",
                                                     "Revenue by feeding guild",
                                                     "Number of anglers and trips; recreational catch",
                                                     "Diversity indices (fishery and species)",
                                                     "Commercial and recreational reliance",
                                                     "Biomass or abundance by feeding guild from surveys",
                                                     "Condition and recruitment of MAFMC managed species",
                                                     "Relative biomass of feeding guilds, primary productivity",
                                                     "Estuarine and offshore habitat conditions"))

knitr::kable(mng_obj,
      col.names = c("Objective Categories","Indicators reported here"),
      caption = "Established ecosystem-scale objectives in New England",
      #align = aca,
      booktabs = T) %>%
  kable_styling(latex_options = "hold_position","scale_down") %>%
 # column_spec(c(2), width = c("25em")) %>%
  row_spec(0, bold = TRUE)
```

# Economic and Social

The objectives of U.S. federal fishery management include providing benefits to the Nation in terms of seafood production and recreational opportunities, while considering economic efficiency and effects on coastal communities. The indicators in this section consider these objectives for the GOM and GB ecological production units separately where possible.

## Gulf of Maine
A long term significant decrease in NEFMC managed species revenue was offset by non-NEFMC managed species (Fig. \ref{fig:comm-revenue-ne}), likely lobster, as indicated by the focal component-level Bennet Volume Indicator for Benthivores (Fig. \ref{fig:bennet-ne}). 

```{r comm-revenue-ne, fig.cap = "Total commercial revenue (black) and revenue from NEFMC managed species (red) in Gulf of Maine (left) and Georges Bank (right).", fig.width = 8, fig.asp = 0.25}

#Filtering and aggregation step
rev_agg <- ecodata::comdat %>% 
  filter(str_detect(Var, "Revenue"),
         !str_detect(Var, "prop|Other|MAFMC"), #Remove proportions, "Other" category species, NEFMC managed species in MAB
         EPU %in% epu_abbr,
         Time >= 1986) %>% 
  mutate(Status = ifelse(str_detect(Var, "Revenue weight"), 
                         "Managed","Total")) %>% #Create groups for aggregation
  group_by(EPU,Status, Time) %>% 
  dplyr::summarise(Total = sum(Value)) %>% 
  group_by(EPU,Status) %>% 
  mutate(hline = mean(Total))

series.col <- c("indianred","black")

#Plotting
gom_rev_agg <- rev_agg %>% filter(EPU == "GOM") %>% 
ggplot() +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+  
  
  #lines
  geom_gls(aes(x = Time, y = Total,
               group = Status),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Total, color = Status), size = lwd) +
  geom_point(aes(x = Time, y = Total, color = Status), size = pcex) +

  #axes
  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Revenue (10"^6*"USD)")) +
  geom_hline(aes(yintercept = hline,
               color = Status),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() +
    ggtitle("Gulf of Maine")

gb_rev_agg <- rev_agg %>% filter(EPU == "GB") %>% 
ggplot() +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+  
  
  #lines
  geom_gls(aes(x = Time, y = Total,
               group = Status),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Total, color = Status), size = lwd) +
  geom_point(aes(x = Time, y = Total, color = Status), size = pcex) +

  #axes
  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Revenue (10"^6*"USD)")) +
  geom_hline(aes(yintercept = hline,
               color = Status),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() +
    ggtitle("Georges Bank")

cowplot::plot_grid(gom_rev_agg, gb_rev_agg, ncol = 2)

# rev_inline <- rev_agg %>% 
#   dplyr::select(Status, Time, Total) %>% 
#   spread(.,Status, Total) %>% 
#   group_by(EPU) %>% 
#   mutate(percent_managed = round(Managed/Total * 100)) %>% 
#   filter(Time > latest_landings_data - 5, Time <= latest_landings_data) %>% 
#   pull(percent_managed)
# 
# min_rev_perc <- min(rev_inline)
# max_rev_perc <- max(rev_inline)
```

```{r bennet-ne, fig.cap = paste0("Revenue change from the long-term mean in 2015 dollars (black), Price (PI), and Volume Indicators (VI) for commercial benthivore landings in Gulf of Maine (left) and for commercial benthos landings on Georges Bank (right)."), fig.height = 3, fig.width=8}

#Filter data into two dataframes for plotting
indicators <- ecodata::bennet %>% 
  filter(EPU %in% epu_abbr,
         Var %in% c("Benthivore VI",
                    "Benthivore PI", 
                    "Benthos VI",
                    "Benthos PI")) %>% 
  mutate(Var, Var = plyr::mapvalues(Var, from = c("Benthivore VI","Benthivore PI",
                                                  "Benthos VI", "Benthos PI"),
                                    to = c("Benthivore Volume","Benthivore Price",
                                           "Volume","Price")))

revchange <- ecodata::bennet %>% 
  filter(EPU %in% epu_abbr,
         Var %in% c("REVCHANGE EPU aggregate"))

#custom bar fill color (color-blind friendly)
ind_fill <- c("#a6cee3", "#b2df8a")

#limits
y.lim <- c(-350,350)

#plot

gom_bennet <- indicators %>% filter(EPU == "GOM" & Var %in% c("Benthivore Volume","Benthivore Price")) %>% 
ggplot()+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  #guides(color = F, fill = F)+
  geom_bar(aes(x=Time, y= Value, fill = Var), stat="identity")+
  scale_fill_manual(name = "Indicators", values = ind_fill, guide = FALSE) +
  geom_line(data = revchange[revchange$EPU == "GOM",], aes(x = Time, y = Value, colour="$"))+
  scale_colour_grey(name ="Total Revenue Change") +
  ggtitle("Gulf of Maine Benthivores Component")+
  labs(y="Value $1,000,000 ($2015)") +
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), limits = y.lim, expand = c(0.01, 0.01)) +
  theme_ts() +
  theme(title = element_text(size = 10)) +
  theme(legend.position="bottom", legend.direction = "horizontal", legend.background = element_rect(fill = "transparent"), legend.title = element_blank(), legend.text = element_blank())

gb_bennet <- indicators %>% filter(EPU == "GB" & Var %in% c("Volume","Price")) %>% 
ggplot()+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf)+
  
  geom_bar(aes(x=Time, y= Value, fill = Var), stat="identity")+
  scale_fill_manual(name = "Indicators", values = ind_fill) +
  geom_line(data = revchange[revchange$EPU == "GB",], aes(x = Time, y = Value, colour="$"))+
  scale_colour_grey(name ="Total Revenue Change") +
  ggtitle("Georges Bank Benthos Component")+
  labs(y="") +
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  scale_y_continuous(breaks = seq(y.lim[1], y.lim[2], by = 100), limits = y.lim, expand = c(0.01, 0.01)) +
  theme_ts() +
  theme(title = element_text(size = 10)) +
  theme(legend.position="bottom", legend.direction = "horizontal", legend.background = element_rect(fill = "transparent"), legend.title = element_text(size = 8), legend.text = element_text(size = 8)) +
  guides(color = guide_legend(order = 1),
         fill = guide_legend(order = 0))

#cowplot::plot_grid(gom_bennet, gb_bennet, ncol = 2, rel_widths = c(1,1))

#extract legend
#https://github.com/hadley/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

mylegend<-g_legend(gb_bennet)

p3 <- gridExtra::grid.arrange(gridExtra::arrangeGrob(gom_bennet + theme(legend.position="none"),
                         gb_bennet + theme(legend.position="none"),
                         nrow=1),
             mylegend, nrow=2,heights=c(6, 1))

```

There is a concurrent significant decrease in NEFMC-managed commercial seafood production and landings (Fig. \ref{fig:total-landings-ne}), with Piscivores, Planktivores, and NEFMC-managed Benthivores showing long term negative trends (Fig. \ref{fig:comm-landings-ne}). This trend is a continuation on the reliance on a small number of species, which could induce additional risk in the social system. 

```{r total-landings-ne, fig.cap = paste0("Total commercial seafood landings (black) shown with NEFMC managed seafood landings (red) in Gulf of Maine (left) and Georges Bank (right)."), fig.width = 8, fig.asp = 0.25}
#Managed landings
managed_landings <- ecodata::comdat  %>%
  filter(str_detect(Var, paste0(council_abbr," managed species - Landings weight|JOINT managed species - Landings weight")),
         !str_detect(Var, "Other"),
         Time >= 1986,
         EPU %in% epu_abbr)

#Total landings
total_landings <- ecodata::comdat  %>%
  filter(!str_detect(Var, "managed species"),
         !str_detect(Var, "Other"),
         str_detect(Var, "Landings"),
         Time >= 1986,
         EPU %in% epu_abbr)

total_landings_agg <- total_landings %>%
  group_by(EPU,Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  mutate(Var = "Total",hline = mean(Value))
managed_landings_agg <- managed_landings %>%
  group_by(EPU,Time) %>%
  dplyr::summarise(Value = sum(Value)) %>% 
  mutate(Var = "Managed",hline = mean(Value))

landings_agg <- rbind(total_landings_agg, managed_landings_agg) 

gom_total <- landings_agg %>% filter(EPU == "GOM") %>% 
ggplot()+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Landings (10"^3*"metric tons)")) +

  geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
    theme_ts() +
  ggtitle("Gulf of Maine")

gb_total <- landings_agg %>% filter(EPU == "GB") %>% 
ggplot()+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Landings (10"^3*"metric tons)")) +

  geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
    theme_ts() +
  ggtitle("Georges Bank")

cowplot::plot_grid(gom_total, gb_total, ncol = 2)

```

One notable signal suggesting increased importance of non-NEFMC managed species is the divergence between NEFMC managed and non-NEFMC managed Planktivore landings in last 5 years in the GOM (Fig. \ref{fig:comm-landings-ne}), the result of lower Atlantic herring landings relative to other planktivores. Additionally, the importance of state-managed fisheries continues to increase, with highly dependant and thus highly vulnerable ports in Maine relying on lobster.

```{r comm-landings-ne, warning=F, fig.width = 8, fig.asp = .75,fig.cap = paste0(council_abbr," managed species landings (red) and total commercial landings (black) by feeding guild in Gulf of Maine (left) and Georges Bank (right).")}
#Get data for plotting

#Managed landings
managed_landings <- ecodata::comdat  %>%
  filter(str_detect(Var, paste0(council_abbr," managed species - Landings weight|JOINT managed species - Landings weight")),
         !str_detect(Var, "Other"),
         Time >= 1986,
         EPU %in% epu_abbr)

#Total landings
total_landings <- ecodata::comdat  %>%
  filter(!str_detect(Var, "managed species"),
         !str_detect(Var, "Other"),
         str_detect(Var, "Landings"),
         Time >= 1986,
         EPU %in% epu_abbr)

#Assign feeding guild column for plotting with ggplot
landings <- rbind(managed_landings, total_landings) %>%
  mutate(feeding.guild = str_extract(Var,paste(feeding.guilds, collapse = "|")),
         grouping = factor(ifelse(str_detect(Var,council_abbr), "managed",
                                  ifelse(str_detect(Var, "JOINT"), "joint","total"))),
         Var = paste(word(feeding.guild), grouping)) %>% 
  mutate(feeding.guild = factor(feeding.guild, levels = feeding.guilds))

#Add JOINT landings to MANAGED landings and remove
landings[landings$Var ==  "Piscivore managed" & landings$EPU == "GOM",]$Value <- landings[landings$Var ==  "Piscivore managed" & landings$EPU == "GOM",]$Value + landings[landings$Var ==  "Piscivore joint" & landings$EPU == "GOM",]$Value

landings[landings$Var ==  "Piscivore managed" & landings$EPU == "GB",]$Value <- landings[landings$Var ==  "Piscivore managed" & landings$EPU == "GB",]$Value + landings[landings$Var ==  "Piscivore joint" & landings$EPU == "GB",]$Value

landings <- landings %>%
  filter(Var != "Piscivore joint")  %>% 
  group_by(Var, EPU) %>% 
  mutate(hline = mean(Value))
  
series.col <- c("indianred","black")

#Create dataframe for label locations
label_loc <- landings %>%
  group_by(feeding.guild) %>%
  dplyr::summarise(yloc = max(Value)*0.95,
                   xloc = min(Time)) %>% 
  mutate(label = LETTERS[1:5])

#facet names for titles
facet_names <- list("Apex predators" = expression("Apex predators"),
                    "Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))

gom_landings <- landings %>% filter(EPU == "GOM") %>% 
  ggplot(aes(x = Time, y = Value, color = grouping)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               group = Var)) +
  
  #Add time series
  geom_line(size = lwd) +
  geom_point(size = pcex) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 color = grouping,
                 size = grouping),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(feeding.guild~.,scales = "free_y", labeller = label, ncol = 1) +
  
  #Axis and theme
  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ylab(expression("Landings, 10"^3*"metric tons")) +
  theme_facet() +
  theme(strip.text=element_text(hjust=0)) +
  ggtitle("Gulf of Maine")

gb_landings <- landings %>% filter(EPU == "GB") %>% 
  ggplot(aes(x = Time, y = Value, color = grouping)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               group = Var)) +
  
  #Add time series
  geom_line(size = lwd) +
  geom_point(size = pcex) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 color = grouping,
                 size = grouping),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(feeding.guild~.,scales = "free_y", labeller = label, ncol = 1) +
  
  #Axis and theme
  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ylab(expression("Landings, 10"^3*"metric tons")) +
  theme_facet() +
  theme(strip.text=element_text(hjust=0)) +
  ggtitle("Georges Bank")

cowplot::plot_grid(gom_landings, gb_landings, ncol = 2)

```

## Georges Bank
In contrast with the GOM, GB total landings and revenue have no long term trends for NEFMC-managed species (Fig. \ref{fig:total-landings-ne}). Rather, fluctuations in GB total revenue and in particular benthos landings (Fig. \ref{fig:comm-landings-ne}) may be associated with rotational management for scallops altering effort between the GB and MAB ecological production units. Planktivore landings on GB have increased over the long term, but have returned to the long term average in 2017.  Price and volume components of revenue are both lower since 2015 (slightly down from the long-run average, Fig. \ref{fig:bennet-ne}), driven by generally decreased landings and despite improved Benthivore, Other, and Planktivore prices. Scallop revenue continues to play an oversized role in Georges Bank dynamics.

## New England-wide
New England social-ecological systems are each reliant on a single crustacean or shellfish species for the majority of commercial fisheries revenue (lobster in GOM, scallop in GB). This reliance likely represents heightened risk to fishing communities, particularly along the coast of Maine and the South Coast in MA in ports which are highly engaged and reliant on commercial fishing (Fig. \ref{fig:NE-comm-reliance-maps-outlined}). This risk is heightened by the moderate to high climate vulnerability of crustaceans and shellfish, which face risks from ocean acidification as well as increased temperature [@hare_vulnerability_2016]. 

```{r NE-comm-reliance-maps-outlined, fig.height = 8, fig.cap = "Commercial engagement (total pounds landed, value landed, commercial permits and commercial dealers in a community) and reliance (per capita engagement) based on 2016 landings and the ACS running average of 2012-2016 census data."}
# Set lat/lon window for maps
xmin = -76
xmax = -66
ymin = 40
ymax = 46
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

biv_col <- c("4" = "#ca0020", "3" = "#f4a582", "2" = "grey", "1" = "#92c5de", "0" = "#0571b0")

eng_rel <- ecodata::eng_rel %>%
    filter(PRIMARY_LATITUDE > 40) %>% 
  dplyr::rename(comeng = ComEng_NE16_ct,
                comrel = ComRel_NE16_ct,
                receng = RecEng_NE16_ct,
                recrel = RecRel_NE16_ct,
                Latitude = PRIMARY_LATITUDE,
                Longitude = PRIMARY_LONGITUDE,
                State = STATEABBR) %>% 
  mutate(comsum = sum(as.numeric(comeng), as.numeric(comrel))) %>% 
  mutate(comeng = factor(comeng, ordered = TRUE, levels = 1:4),
         comrel = factor(comrel, ordered = TRUE, levels = 1:4),
         receng = factor(receng, ordered = TRUE, levels = 1:4),
         recrel = factor(recrel, ordered = TRUE, levels = 1:4))



(com <- eng_rel %>% 
  dplyr::select(comeng, comrel, comsum, Latitude, Longitude) %>% 
  filter(comeng != 0 &
         comrel != 0) %>% 
ggplot() +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data  = ne_states, size = map.lwd) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  geom_point(aes(x = Longitude, y = Latitude,
                 fill = comeng, size = comrel),
             color = "black",pch = 21) +
  guides(fill = guide_legend(override.aes = list(size = 5),
                            reverse = T,
                            title = "Engagement"),
         size = guide_legend(reverse = T,
                            title = "Reliance")) +
  scale_fill_manual(values = biv_col) +
  theme_map() +
  xlab("Longitude") +
  ylab("Latitude") +
      theme(legend.position = c(0.8, 0.25), 
        legend.box = "horizontal",
        legend.direction = "vertical",
        legend.key=element_blank(),
        legend.key.width = unit(0, "cm"))+
  ggtitle("Commercial Reliance & Engagement"))

# com + rec + plot_layout(ncol = 2) &
#   theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

```

Commercial fleet diversity indices were updated with 2017 data. Current diversity remains near the long term average. 

In contrast to commercial species specialization, indicators highlight an increasing diversity of recreational species caught in New England (Fig. \ref{fig:rec-div}), although recreational fleet effort diversity has not changed over the long term. 

```{r rec-div, fig.width = 4, fig.asp = 0.8, fig.cap = paste0("Recreational effort diversity and diversity of recreational catch in the ",region,".")}

recdat <- ecodata::recdat %>% 
  filter(EPU == "NE") %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))

ylim_re <- c(5e6, 30e6)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(0, 2e6)

series.col <- "black"

rec_div <- recdat %>% 
  filter(Var == "Recreational fleet effort diversity across modes") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    #label
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational fleet effort diversity across modes",]$labels,
  #          size = letter_size)+
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ylim(ylim_rd)+
  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ggtitle("Rec. fleet effort diversity")+
  ylab(expression("Effective Shannon")) +
  xlab("")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()


rec_div_catch <- recdat %>% 
  filter(Var == "Recreational Diversity of Catch") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    # annotate("text", 
    #        x = label_loc[label_loc$Var == "Recreational anglers",]$xloc,
    #        y = label_loc[label_loc$Var == "Recreational anglers",]$yloc,
    #        label = label_loc[label_loc$Var == "Recreational anglers",]$labels,
    #        size = letter_size)+
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ggtitle("Rec. diversity of catch")+
  ylab(expression("Effective Shannon")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()

cowplot::plot_grid(#rec_effort, 
                   rec_div, 
                   #rec_anglers, 
                   rec_div_catch,
                   ncol = 1, 
                   align = "hv") +
    theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

```

Recreational seafood production shows an increasing trend since the mid-1990s with the updated Marine Recreational Information Program (MRIP) data (Fig. \ref{fig:rec-landings-ne})). 

```{r rec-landings-ne, fig.cap = paste0("Total recreational seafood harvest in ",region,"."), fig.width = 4, fig.asp = 0.45}

landings_rec <- ecodata::recdat %>% 
  filter(EPU == "NE",
         Var == "Recreational Seafood") %>% 
  mutate(hline = mean(Value))

series.col <- "black"

ggplot(data = landings_rec)+
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +
  ggtitle("NE Recreational seafood harvest")+
  scale_y_continuous(labels = function(l){trans = l / 1000000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ylab(expression("Fish caught (10"^6*"n)")) +

  geom_hline(aes(yintercept = hline,
               
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()

```

Updated indicators for recreational opportunities (effort days and number of anglers) show general increases since the 1990s, peaking in the late 2000s and declining since then. This is similar to previously reported trends (Fig. \ref{fig:rec-op}). All recreational indicators have been updated with new MRIP data, and indicators for recreational diversity are new for this report. 

```{r rec-op, fig.width = 4, fig.asp = 0.8, fig.cap = paste0("Recreational effort and number of recreational anglers in the ",region,".")}
recdat <- ecodata::recdat %>% 
  filter(EPU == "NE") %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))

ylim_re <- c(5e6, 30e6)
ylim_rd <- c(1.75,2.75)
ylim_ra  <- c(0, 2e6)

#Create dataframe for label locations
# label_loc <- data.frame(xloc = min(recdat$Time)+0.3,
#                         yloc = c(ylim_re[2]*0.975,
#                                  ylim_rd[2]*0.975,
#                                  ylim_ra[2]*0.975),
#                         labels = LETTERS[1:3],
#                         Var = c("Recreational Effort",
#                                 "Recreational fleet effort diversity across modes",
#                                 "Recreational anglers"))

series.col <- "black"
#x.shade.min <- max(recdat$Time, na.rm = T) - 9
#x.shade.max <- max(recdat$Time, na.rm = T)

series.col <- "black"

rec_effort <- recdat %>% 
  filter(Var == "Recreational Effort") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    #label
  # annotate("text", 
  #          x = label_loc[label_loc$Var == "Recreational Effort",]$xloc,
  #          y = label_loc[label_loc$Var == "Recreational Effort",]$yloc,
  #          label = label_loc[label_loc$Var == "Recreational Effort",]$labels,
  #          size = letter_size)+
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_y_continuous(labels = function(l){trans = l / 1000000}, limits = ylim_re)+
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ggtitle("Recreational effort") +
  ylab(expression("Days fished (10"^6*" days)")) +
  xlab("")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 


rec_anglers <- recdat %>% 
  filter(Var == "Recreational anglers") %>% 
  ggplot() + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
    # annotate("text", 
    #        x = label_loc[label_loc$Var == "Recreational anglers",]$xloc,
    #        y = label_loc[label_loc$Var == "Recreational anglers",]$yloc,
    #        label = label_loc[label_loc$Var == "Recreational anglers",]$labels,
    #        size = letter_size)+
  geom_gls(aes(x = Time, y = Value,
               group = Var),
             alpha = trend.alpha, size = trend.size) +
  geom_line(aes(x = Time, y = Value, color = Var), size = lwd) +
  geom_point(aes(x = Time, y = Value, color = Var), size = pcex) +

  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_y_continuous(labels = function(l){trans = l / 1000000}, limits = ylim_ra)+
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ggtitle("Recreational anglers")+
  ylab(expression("Anglers (10"^6*" n)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline,
               color = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()

cowplot::plot_grid(rec_effort, 
                   #rec_div, 
                   rec_anglers, 
                   #rec_div_catch,
                   ncol = 1, 
                   align = "hv") +
    theme(plot.margin = unit(c(0.1, 0, 0, 0), "cm"))

```

Recreational fishing is important to many New England communities, particularly in Southern New England (MA, RI, CT; Fig. \ref{fig:NE-rec-engage}). Communities that are most socially and economically dependent (both engaged and reliant) on recreational fishing may benefit from the increased diversity of recreational species catch. Additional social indicators for New England communities are available online^[https://www.st.nmfs.noaa.gov/humandimensions/social-indicators/]. 

```{r NE-rec-engage, fig.height = 8, fig.cap = "Recreational engagement (shore, private vessel and for-hire recreational fishing in a community) and reliance (per capita engagement) based on 2016 landings and the ACS running average of 2012-2016 census data."}
(rec <- 
  eng_rel %>% 
  dplyr::select(receng, recrel, Latitude, Longitude) %>% 
  filter(receng != 0,
         recrel != 0) %>% 
ggplot() +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data  = ne_states, size = map.lwd) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  geom_point(aes(x = Longitude, y = Latitude,
                 fill = receng, size = recrel),
             color = "black",pch = 21) +
  guides(fill = guide_legend(override.aes = list(size = 5),
                            reverse = T,
                            title = "Engagement"),
         size = guide_legend(reverse = T,
                            title = "Reliance")) +
  scale_fill_manual(values = biv_col) +
  theme_map() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(legend.position = c(0.8, 0.25), 
        legend.box = "horizontal",
        legend.direction = "vertical",
        legend.key=element_blank(),
        legend.key.width = unit(0, "cm"))+
  ggtitle("Recreational Reliance & Engagement"))
```

\newpage

# Protected Species

Protected species include marine mammals (under the Marine Mammal Protection Act), endangered and threatened species (under the Endangered Species Act), and migratory birds (under the Migratory Bird Treaty Act). In the Northeast US, endangered/threatened species include Atlantic salmon, Atlantic and shortnose sturgeon, all sea turtle species, and 5 baleen whales. Fishery management objectives for protected species generally focus on reducing threats and on habitat conservation/restoration; here we report on the status of these actions as well as indicating the potential for future interactions driven by observed and predicted ecosystem changes in the Northeast US region. Atlantic salmon are among the most critically endangered fish and are a NOAA Species in the Spotlight. This year four Unusual Mortality Events (UMEs) have been declared for three large whale species and two seal species, with several mortalities attributed to human interactions. Also, a marine mammal climate vulnerability assessment is currently underway for Atlantic and Gulf of Mexico populations and will be reported on in future versions of this report. Strong evidence exists to suggest that the level of interaction between right whales and the combination of fixed gear in the US and Canada is contributing substantially to the decline of the species.

## Sea turtles (coastwide)
Sea turtles are known to be susceptible to climate and ecosystem changes, and their distribution is influenced by water temperature. Sea turtle diets contain a considerable amount of gelatinous zooplankton, which are also influenced by changes in the ecosystem. At present, management measures to reduce sea turtle-fishery interactions are limited to the regions with historical observations of sea turtles and based on historical ocean temperature distributions. However, changes in climate may cause turtles to shift northward into areas with heavy fishing, possibly resulting in increased bycatch. It has been hypothesized that seasonal distribution of Kempas Ridley sea turtles has shifted northward due to the warming of the Gulf of Maine, which in turn, appears to be resulting in a near record number of cold-stunned turtles stranding in Cape Cod Bay as waters cooled during the fall of 2018.

## Whales (coastwide)
North Atlantic right whales are among the most endangered large whale populations in the world. Changes in right whale trends can have implications for fisheries management where fisheries interact with these whales. Additional management restrictions could have a large impact on fishing times, gears, etc. Although the population increased steadily from 1990 to 2011, it has decreased recently (Fig. \ref{fig:NARW-abundance}). From @pace_statespace_2017: '??The probability that the population'??s trajectory post-2010 was a decline was estimated at 99.99%.'?? Reduced survival rates of adult females and diverging abundance trends between sexes have also been observed. It is estimated that there are only about 100 adult females remaining in the population. Further, right whale distribution has changed since 2010. The reasons for these changes is unclear, but changes in climate and primary prey (*Calanus finmarchicus*) are suspected.
 
Three large whale Unusual Mortality Events (UMEs) have been declared for north Atlantic right whales, humpback whales, and minke whales. In all three cases human interaction appears to have contributed to increased mortalities, although investigations are not complete. Twenty right whale mortalities have been documented in 2017 and 2018 so far. Among the 20 right whale deaths observed in 2017 and 2018 thus far, 5 were due to vessel strike (1 in US waters, 4 in Canadian waters), 6 from entanglement (2 in Canadian gear, 1 in unknown gear, and 3 others found in US waters), and the rest from unknown causes. UMEs have also been declared for humpback whales during 2016-2018 and 2017-2018 minke whales due to elevated strandings. Necropsy investigations on 50% of humpback whales showed evidence of human interaction, either ship strike or entanglement. Similarly, 60% of minke whales show evidence of human interactions or infectious disease. In both cases the investigations are still underway and more research is needed to determine the causes of these UME.

```{r NARW-abundance, fig.width = 5, fig.asp = 0.45,fig.cap = "Right whale abundance estimates with 95\\% credible intervals. These values represent the estimated number of animals alive sometime during the year referenced and NOT at the end of the year referenced. Seventeen known deaths were recorded in 2017 (likely all from anthropogenic causes), but these deaths were not reflected in the 2017 estimate because those animals were alive sometime during the year."}
hline <- mean(narw[narw$Var == "right whale abundance median",]$Value)

ecodata::narw %>% 
  spread(.,Var,Value) %>% 
  ggplot() +
#Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `right whale abundance median`), size = lwd-0.75) +
  geom_point(aes(x = Time, y = `right whale abundance median`), size = pcex-0.75) +
  geom_errorbar(aes(x = Time,
                    ymin = `right whale abundance lcl`,
                  ymax = `right whale abundance ucl`), 
                width = 0.25) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  ggtitle("NARW abundance") +
  ylab(expression("Abundance (n)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts()
```

## Grey seals (coastwide)
The number of grey seals (*Halichoerus grypus*) in U.S. waters has risen dramatically in the last 2 decades, with few observed in the early 1990s to roughly 24,000 observed in southeastern Massachusetts in 2015 (Pace et al. in press). Roughly 30,000 - 40,000 gray seals were estimated in southeastern Massachusetts in 2015, using correction factors applied to seal counts visible in Google Earth imagery. As of 2016, the size of the grey seal population in Canada, which is part of the same stock as the grey seals in the U.S., was estimated to be roughly 425,000, and increasing by 4% a year. Pups born on Muskeget Island MA, currently the largest pupping site for gray seals in the U.S., were first observed in 1988 and now number over 3,500. Trends in pup production at U.S. colonies appear to be increasing, and it is likely that U.S. pup production is being supplemented each year by animals from Canada. A UME for both gray and harbor seals was declared in 2018, triggering an investigation into the cause of this event. Tests so far suggest phocine distemper virus as a potential cause, although the investigation is not yet complete.
 
Fisheries interactions have increased over the past 2 decades, with fewer than 10 total estimated grey seal interactions in 1993, to more than 1000 in 2013 and 2015, and with the preliminary 2017 estimate over 900. Analysis of seal diet is currently underway using a variety of techniques (analysis of stomach contents, fatty acids, and DNA) to assess the potential impact of seal population growth on the ecosystem and important commercial fish species.

## Harbor porpoise (coastwide)
Harbor porpoise bycatch has resulted in fisheries closures in the past, but current bycatch levels suggest that management measures have been effective, reducing this fishery interaction. The 5-year mean bycatch has been below the maximum permitted level (Potential Biological Removal, PBR) since 2011 (Fig. \ref{fig:harbor-porpoise-bars}), and the 2016 and draft 2017 annual bycatch estimates are among the lowest in the time series. Recent compliance with the harbor porpoise take reduction plan and reduced fishing effort are thought to contribute to low bycatch estimates. Potential recent shifts in porpoise distribution could also be contributing to low bycatch and this will be explored during the coming year. A new draft harbor porpoise abundance estimate suggests stable or increasing abundance of the Gulf of Maine/Bay of Fundy harbor porpoise stock. Recent analyses have examined regional harbor porpoise diet, and suggest that harbor porpoise are not typically feeding on fish caught in gillnets. However, the impact of ecosystem changes on bycatch, population, or distribution remain unclear.

```{r harbor-porpoise-bars, fig.width = 5, fig.asp = 0.45, fig.cap = "Harbor porpoise bycatch estimate (black) shown with Potential Biological Removal (red). Error bars indicate 95\\% confidence interval."}
ecodata::harborporpoise %>% 
  spread(.,Var,Value) %>% 
ggplot() +
    annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = lwd) +
  geom_point(aes(x = Time, y = `harbor porpoise bycatch estimate`, color = "Harbor Porpoise Bycatch"), size = pcex) +
  geom_errorbar(aes(x = Time,
                    ymin = `harbor porpoise bycatch lo95ci`,
                  ymax = `harbor porpoise bycatch up95ci`,
                  color = "Harbor Porpoise Bycatch"), 
                width = 0.25)+
  geom_line(aes(x = Time, y = `harbor porpoise bycatch pbr`, color = "PBR"), size = lwd-0.1) +
  scale_color_manual("", values = c("Harbor Porpoise Bycatch" = "black", "PBR" = "red")) +
  guides(color = guide_legend(override.aes = list(shape = c(19,NA)))) +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Harbor porpoise bycatch") +
  ylab("Bycatch Estimate (n)") +
  theme_ts() +
  theme(legend.position = c(0.4, 0.85), legend.background = element_rect(
    fill = "transparent"), legend.text = element_text(size = 10))

```

## Protected fish (coastwide)
The Gulf of Maine DPS of Atlantic salmon is listed as endangered. These salmon are found in coastal waters of New England and now spawn only in Maine rivers. Spawner abundance is less than 10% of historic levels with returns averaging around 1,000 annually since 2012.  They are highly reliant on connectivity between ocean and freshwater habitats to complete their life cycle. They are also extremely sensitive to climate and ecosystem changes since they have specific habitat requirements for each of their life stages. These populations migrate through some of the most rapidly warming marine regions and marine regime shifts have impacted their ocean productivity. The Recovery Plan for the Gulf of Maine DPS of Atlantic Salmon was published in 2019, and it highlights specific actions to conserve and recover the species: enhancing river-ocean connectivity; maintaining genetic diversity; increasing the number of spawning adults; and furthering our understanding of marine and estuarine habitats.  Shortnose sturgeon (endangered) and five distinct populations segments (DPS) of Atlantic sturgeon are found in coastal waters of New England (endangered: New York Bight, Chesapeake Bay, Carolina, and South Atlantic; threatened: Gulf of Maine). Several populations spawn in New England watersheds, and river-ocean connectivity is an important habitat characteristic. These populations are vulnerable to climate and ecosystem changes as their life history results in high biological sensitivity and habitat needs result in very high climate exposure. Threat reductions are focused on protecting critical habitat, habitat restoration, reducing ship-strikes, and bycatch reduction.  

## Common terns (GOM)
Seabird breeding colonies in the GOM are monitored and managed to promote recovery of formerly harvested species. Common terns are well-monitored and are considered good nearshore ecosystem indictators due to their wide distribution and generalist diet. Common terns breed on islands throughout the Gulf of Maine (Fig. \ref{fig:map-and-prey}a), feeding on a wide range of invertebrates and fish including Atlantic herring, juvenile (mainly white) hakes, and sand lance (Fig. \ref{fig:map-and-prey}b). As surface feeding birds, terns are sensitive to vertical distribution of prey as well as nearshore conditions in general, with a foraging distance of 10-20 km from a nesting colony. 

```{r map-and-prey, fig.cap = "Common terns: a. Locations of the seven sampled common tern nesting sites in Gulf of Maine (EER = Eastern Egg Rock, JI = Jenny Island, MR = Matinicus Rock, OGI = Outer Green Island, PINWR = Pond Island National Wildlife Refuge, SINWR = Seal Island National Wildlife Refuge, STI = Stratton Island), and b. Prey frequencies in the diets of common tern observed across the seven colonies in Gulf of Maine. Prey occurring in <5 percent of common tern diets were excluded for clarity.", fig.height = 4, fig.width = 8}

#Map subfig
# Set lat/lon window for maps
xmin = -70.5
xmax = -68.25
ymin = 43
ymax = 44.5
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
island_loc <- data.frame(Island = c("EER","JI","MR","OGI",
                                    "PINWR","SINWR","STI"),
                         Latitude = c(43.861,43.764,43.785,43.650,
                                      43.739,43.886,43.505),
                         Longitude = c(-69.382,-69.909,-68.854,-70.124,
                                       -69.771,-68.742,-70.312))
islands <- ggplot() +
  geom_sf(data = new_england, size = map.lwd) +
  geom_point(data = island_loc, aes(x = Longitude, y = Latitude)) +
  geom_label_repel(data = island_loc, aes(x = Longitude, y = Latitude,
                                          label = Island), nudge_y  = -0.1, 
                   size = 2.5) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  theme_map() +
  ggtitle("Common tern study sites") +
  xlab("Longitude") +
  ylab("Latitude") +
  labs(tag = "a")  +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))
# inset_states <- new_england %>% filter(STATE_NAME %in% c("Maine",
#                                                          "New Hampshire",
#                                                          "Massachusetts"))
# Set lat/lon window for maps
xmin2 = -72
xmax2 = -66.25
ymin2 = 42.5
ymax2 = 47.5
xlims2 <- c(xmin2, xmax2)
ylims2 <- c(ymin2, ymax2)
NE <- ggplotGrob(
ggplot()+
  geom_sf(data = new_england, size = map.lwd) +
  coord_sf(crs = crs, xlim = xlims2, ylim = ylims2) +
  annotate("rect", xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, color = "black",
           size = 0.1, fill = "transparent") +
  theme_map() +
  xlab("") +
  ylab("") +
  theme(panel.border = element_rect(colour = "black", fill = "transparent", size=0.75),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_blank())
)
full_map <- islands +
  annotation_custom(grob = NE, xmin = -69, xmax = -68.25, ymin = 42.9, ymax = 43.6)


# Prey freq stacked bar
prey_freq <- ecodata::common_tern %>% 
  filter(str_detect(Var, "Diet"),
         !str_detect(Var, "Sum")) %>% 
    mutate(Island = word(Var, 1),
         Var = word(Var, 4)) %>%
    group_by(Var, Time) %>% 
    dplyr::summarise(Value = sum(Value, na.rm = T)) %>% 
    group_by(Time) %>% 
    mutate(Freq = Value/sum(Value, na.rm = T)) %>% 
    group_by(Var) %>% 
  mutate(hline = mean(Freq, na.rm = T))

diet_freq_bar <- prey_freq %>% 
  filter(Freq > 0.05) %>% 
  dplyr::mutate(Prey = gsub("\\.", " ", Var)) %>% 
  dplyr::mutate(Prey = gsub("Invertebrate", "Invert.", Prey)) %>% 
  # dplyr::rename(Prey = Var) %>%
  ggplot(aes(x = Time, y = Freq, fill = Prey)) +
  geom_bar(stat = "identity") +
    # geom_bar_interactive(aes(tooltip = paste(Prey,round(Freq,2),Time)),stat = "identity") +
  scale_fill_manual(values = RColorBrewer::brewer.pal(10,"Paired")) +
  ggtitle("Prey composition") +
  ylab("Proportion of prey items") +
  labs(tag = "b")  +
  theme_ts() + 
  theme(legend.text = element_text(size = 8))


# diet_freq_bar <- girafe(ggobj = diet_freq_bar)
# diet_freq_bar <- girafe_options(diet_freq_bar, opts_zoom(max = 5) )

full_map + diet_freq_bar + plot_layout(ncol = 2, widths=c(4,4))
```

GOM common tern average productivity (fledglings per nest) across 7 colonies has varied over time but was low in 2018 (Fig. \ref{fig:tern-prod-div}a), a year with record-high summer SST in the GOM (Fig. \ref{fig:NE-SST-anom-series}), and substantial butterfish in tern diets (Fig. \ref{fig:map-and-prey}b). 

```{r tern-prod-div, fig.cap = "a. Mean common tern productivity at nesting sites in Gulf of Maine. Error bars show +/- 1 SE of the mean. b. Shannon diversity of common tern diets observed at nesting sites in Gulf of Maine. Diversity of common tern diets has been predominantly above the long-term mean since 2006.",fig.width = 8, fig.asp = 0.25 }
aggregate_prod <- ecodata::common_tern %>% 
    filter(!str_detect(Var, "Diet|Sum"))  %>% 
  mutate(Island = word(Var, 1),
         Var = word(Var, 3),
         Island = plyr::mapvalues(Island, from = c("EER","JI","MR","OGI","PINWR","SINWR","STI"),
                                  to = c("Eastern Egg Rock", "Jenny Island", "Matinicus Rock", "Outer Green Island", "Pond Island", "Seal Island","Stratton Island"))) %>%
  group_by(Time) %>% 
  dplyr::summarise(Mean = mean(Value, na.rm = T),
                   SE = sd(Value, na.rm = T)/sqrt(n()),
                   SD = sd(Value, na.rm = T),
                   n = n()) %>% 
  mutate(Mean = ifelse(is.na(SE),NA,Mean),
         se.low = Mean - SE,
         se.high = Mean + SE,
         hline = mean(Mean, na.rm = T))

prodplot <- aggregate_prod %>% ggplot() +
#Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Mean), size = lwd-0.75) +
  geom_point(aes(x = Time, y = Mean), size = pcex-0.75) +
  geom_gls(aes(x = Time, y = Mean)) +
  geom_errorbar(aes(x = Time,
                    ymin = se.low,
                  ymax = se.high), 
                width = 0.25) +
  scale_x_continuous(expand = c(0.01, 0.01),limits = c(1991,2018)) +
  guides(color = FALSE) +
  ggtitle("Common tern productivity") +
  ylab(expression("Fledged chicks per nest")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  labs(tag = "a")  +
  theme_ts()

diet_div <- ecodata::common_tern %>% 
  filter(str_detect(Var, "Diet"),
         !str_detect(Var, "Sum")) %>% 
  mutate(Island = word(Var, 1),
         Var = word(Var, 4)) %>% 
  group_by(Island, Time) %>%
  dplyr::summarise(evenness = diversity(Value)/log(specnumber(Value)),
                   shannon = diversity(Value),
                   simpson = diversity(Value, index = "simpson")) %>% 
  gather(.,Var,Value,-Island, -Time) %>% 
  group_by(Var, Time) %>%
  dplyr::summarize(Value = mean(Value, na.rm = T),
                   sd = sd(Value, na.rm = T),
                   n = n()) %>%
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T))

# evenness <- diet_div %>% 
#   filter(Var == "evenness") %>% 
# ggplot(aes(x = Time, y = Value)) +
#       annotate("rect", fill = shade.fill, alpha = shade.alpha,
#       xmin = x.shade.min , xmax = x.shade.max,
#       ymin = -Inf, ymax = Inf) +
#   geom_line() +
#   geom_point() +
#  # geom_gls() +
#   scale_x_continuous(expand = c(0.01, 0.01),limits = c(1992,2018)) +
#   ggtitle("Evenness")+
#   ylab(expression("Evenness")) +
#   xlab("")+
#   geom_hline(aes(yintercept = hline),
#            size = hline.size,
#            alpha = hline.alpha,
#            linetype = hline.lty) +
#   theme_ts() 

shannon <- diet_div %>% 
  filter(Var == "shannon") %>% 
ggplot(aes(x = Time, y = Value)) +
      annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  #geom_gls() +
  scale_x_continuous(expand = c(0.01, 0.01),limits = c(1992,2018)) +
  ggtitle("Common tern diet diversity")+
  ylab(expression("Shannon Diversity")) +
  xlab("")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  labs(tag = "b")  +
  theme_ts() 

prodplot + shannon + plot_layout(ncol = 2, widths=c(4,4))
```

The presence of butterfish in tern diets reflects the extension of this warm water species into GOM. Due to their thin, deep body form, butterfish are often difficult for small seabird chicks to ingest and swallow, causing chicks to starve and/or parent birds to increase foraging effort. GOM common tern diet diversity was mainly above the long term mean since 2006 (Fig. \ref{fig:tern-prod-div}b). High diet diversity may be related to lower availability of preferred prey types such as herring and sand lance relative to increased availability of other species associated with warmer SST.

\newpage

# Fish and Invertebrates

Fishery management aims to keep individual harvested species within population ranges where productivity is maximized over the long-term. However, these managed species represent a subset of the full ecosystem, interacting with a wider range of predators and prey and relying on diverse habitats. Indicators in this section summarize single species status as well as tracking trends for broad categories of fish within the ecosystem, including changes in biomass, distribution, condition, and diversity. Changes in overall predator and prey levels as well as distribution have implications for managed fish productivity, fishing operations, and regional fishery management. 

## Stock status and aggregate distribution (coastwide)
Fishery management objectives are being met for 20 (including 6 skate) stocks at the single species level. Stocks in Fig. \ref{fig:NE-stock-status} which are above the F threshold (horizontal line) are experiencing overfishing (F > Fmsy). Stocks in Fig. \ref{fig:NE-stock-status} which are below the B threshold (dashed vertical line) are overfished (B < 0.5Bmsy). For the stocks with either missing F or B values in Fig. \ref{fig:NE-stock-status}, additional information has been used to determine overfishing and overfished status. Official stock status for New England stocks^[https://www.st.nmfs.noaa.gov/sisPortal/mapTool.jsp] lists 6 stocks subject to overfishing (GOM cod, GB cod, southern red hake, and all 3 yellowtail flounder stocks), and 13 stocks as overfished (GOM cod, GB cod, southern red hake, Atlantic halibut, Atlantic wolffish, ocean pout, thorny skate, GOM/GB windowpane flounder, southern New England/mid-Atlantic winter flounder, witch flounder, and all 3 yellowtail flounder stocks). Five stocks have unknown status for B and F.

```{r NE-stock-status, warning=F, fig.cap = paste0("Summary of single species status for ",council_abbr," and jointly managed stocks. \\label{stock-status}"), fig.width = 8, fig.asp = 0.65}

#Get data, spread for plotting, and filter
stock_status <- ecodata::stock_status %>%
  spread(.,Var,Value) %>% 
  filter(Council %in% c(council_abbr,"Both"))

#Plot constants
y.max <- 4.5
x.max <- 7.5

all_missing <- stock_status %>%
  filter(is.na(B.Bmsy),is.na(F.Fmsy)) %>% 
  dplyr::select(Code, Council)

b_missing <- stock_status %>%
  filter(is.na(B.Bmsy), !is.na(F.Fmsy)) %>% 
  dplyr::select(Code, Council)

f_missing <- stock_status %>%
  filter(is.na(F.Fmsy), !is.na(B.Bmsy)) %>% 
  dplyr::select(Code, Council)

#A dataframe that defines custom legend for stocks with unknown status

all.df <- tibble(text = all_missing$Code,
                    x = rep(x.max,length(all_missing$Code)),
                    y = seq(4.35,2.85,-0.22),
                    color = all_missing$Council)

b.df <- tibble(text = b_missing$Code,
                    x = rep(x.max*0.8,length(b_missing$Code)),
                    y = c(4.35,4.14),
                    color = b_missing$Council)

f.df <- tibble(text = f_missing$Code,
                    x = rep(x.max*0.6,length(f_missing$Code)),
                    y = seq(4.35,2.85,-0.22),
                    color = f_missing$Council)


#Plotting code
ggplot(data = stock_status) +
  geom_vline(xintercept = 1, linetype = "dotted", color = "grey60")+
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "grey60")+
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey60") +
  geom_point(aes(x = B.Bmsy,
                 y = F.Fmsy,
                 color = Council,
                 shape = Council)) +
  geom_text_repel(aes(x = B.Bmsy, #geom_text_repel auto-jitters text around points
                      y = F.Fmsy,
                      label = Code,
                      color = Council), show.legend = FALSE,nudge_y = 0.05, nudge_x = 0.05) +
  ylim(0,y.max) +
  xlim(0,x.max*1.1) +
  geom_text(data = all.df, aes(x = x, y = y, label = text, color = color),show.legend = FALSE, size = 3)+
  geom_text(data = b.df, aes(x = x, y = y, label = text, color = color),show.legend = FALSE, size = 3)+
  geom_text(data = f.df, aes(x = x, y = y, label = text, color = color),show.legend = FALSE, size = 3)+
  scale_color_manual(values = c("purple","blue"),#c("purple","blue"), #Change legend labels for clarity
                   name = "Managed by",
                   breaks = c("Both","NEFMC"),
                   labels = c("MAFMC/NEFMC","NEFMC"))+
  scale_shape_manual(values = c(1, 19), #Change legend labels for clarity
                     name = "Managed by",
                     breaks = c("Both","NEFMC"),
                     labels = c("MAFMC/NEFMC","NEFMC"))+
  annotate("rect", xmin = 0.924*x.max,
           xmax = 1.08*x.max,
           ymin = 0.645*y.max,
           ymax = 0.98*y.max,
           alpha = 0.01) +
  annotate("text", x = 7.5, y = 4.5, label = "F and B missing", fontface =2, size = 3)+
    annotate("rect", 
             xmin = 0.729*x.max,
           xmax = 0.871*x.max,
           ymin = 0.905*y.max,
           ymax = 0.98*y.max,
           alpha = 0.01) +
  annotate("text", x = 6, y = 4.5, label = "B missing", fontface =2, size = 3)+
    annotate("rect", xmin = 0.509*x.max,
           xmax = 0.681*x.max,
           ymin = 0.65*y.max,
           ymax = 0.98*y.max,
           alpha = 0.01) +
  annotate("text", x = 4.5, y = 4.5, label = "F missing", fontface =2, size = 3)+
  xlab(expression(~B/B[msy])) +
  ylab(expression(~F/F[msy])) +
  theme_ts()
```

Changes in the distribution of managed fish species continue, with aggregate trends on the entire Northeast Shelf towards the northeast and generally into deeper water (Fig. \ref{fig:spec-dist}). These shifts will place increasing pressure on a management system based around stable species distributions. 

```{r spec-dist,fig.width = 4, fig.asp = 1.2, fig.cap = "Aggregate species distribution metrics for species in the Northeast Large Marine Ecosystem."}

spec_dist <- ecodata::species_dist %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))

asd <- spec_dist %>% 
  filter(Var == "along-shelf distance") %>% 
  ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Along-shelf distance")+
  ylab(expression("Distance (km)")) +
  xlab("")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

depth <- spec_dist %>% 
  filter(Var == "depth") %>% 
  ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Depth")+
  ylab(expression("Depth (m)")) +
  xlab("")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

dtc <- spec_dist %>% 
  filter(Var == "distance to coast") %>% 
  ggplot(aes(x = Time, y = Value,
               group = Var)) + 
 #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  scale_x_continuous(expand = c(0.01, 0.01)) +
  ggtitle("Distance to coast")+
  ylab(expression("Distance (km)")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() 

asd + depth + dtc + plot_layout(ncol = 1) 

```

## Survey biomass (GOM and GB)
Biomass across trophic levels shows similar trends between the Gulf of Maine and Georges Bank offshore, but nearshore trends differ for some groups. For both the GOM and GB, there are long term increasing trends in aggregate NEFSC (offshore) survey biomass for Piscivores, Planktivores and Benthos in the fall. (Figs. \ref{fig:gom-biomass-ne}, \ref{fig:gb-biomass-ne}). GB spring Benthos and GOM spring Planktivores are also increasing over the long term. However, there are some notable departures from these trends recently. 

```{r gom-biomass-ne, fig.cap = paste0("Fall (left) and spring (right) NEFSC surveyed biomass in the Gulf of Maine."), fig.width=8, fig.asp = 0.75}
total_surv <- nefsc_survey %>% 
  filter(EPU %in% c("GOM","GB"),
         !str_detect(Var, "Other|Apex|managed"),
         Time >= 1968) %>% 
  group_by(EPU,Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(Var = word(Var, 1,2))
series.col <- rep("black",length(unique(total_surv$Var)))
total_surv$Var <- factor(total_surv$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))



#facet names for titles
facet_names <- list("Piscivores" = expression("Piscivores"),
                    "Planktivores" = expression("Planktivores"),
                    "Benthivores" = expression("Benthivores"),
                    "Benthos" = expression("Benthos"))

gom_surv <- total_surv %>% 
  filter(EPU == "GOM") %>% 
ggplot(aes(x = Time, y = Value, color = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("GOM NEFSC BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

gom_surv
```

```{r gb-biomass-ne, fig.cap = paste0("Fall (left) and spring (right) NEFSC surveyed biomass on Georges Bank."), fig.width=8, fig.asp = 0.75}

gb_surv <- total_surv %>% 
  filter(EPU == "GB") %>% 
ggplot(aes(x = Time, y = Value, color = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("GB NEFSC BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

gb_surv

```

Benthivore biomass catch in both offshore surveys has shown recent declines from 2015 highs in both fall and spring. This contrasts with inshore surveys showing more stable Benthivore biomass in the past few years (Figs \ref{fig:MA-inshore}, \ref{fig:menh-survey}). Change in haddock catch is the largest contributor to these fluctuations. 
 
```{r MA-inshore, fig.width=8, fig.asp = 0.75, fig.cap = "Fall (left) and spring (right) surveyed biomass from the MA state inshore bottom trawl survey."}
mass <- mass_inshore_survey %>% 
  filter(str_detect(Var, "Index")) %>% 
  mutate(feeding.guild = str_extract(Var, paste(feeding.guilds, collapse = "|")),
         Season = str_extract(Var, "Spring|Fall")) %>%
  filter(!is.na(feeding.guild)) %>% 
  unite(.,Var, c("feeding.guild","Season"),sep = " ") %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))
mass$Var <- factor(mass$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))

mass %>% 
  ggplot(aes(x = Time, y = Value, color = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  geom_gls(aes(x = Time, y = Value,
               color = Var),
             alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("MA Inshore BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

```

```{r menh-survey,fig.width=8, fig.asp = 0.75, fig.cap = "Fall (left) and spring (right) surveyed biomass from the ME/NH state inshore bottom trawl survey."}

menh <- ecodata::ne_inshore_survey %>% 
  filter(Units != "CV",
         !str_detect(Var, " se| ci")) %>% 
  mutate(feeding.guild = str_to_title(str_extract(Var, paste(tolower(feeding.guilds), collapse = "|"))),
         Season = str_to_title(str_extract(Var, "fall|spring"))) %>% 
    unite(.,Var, c("feeding.guild","Season"),sep = " ") %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value))
  

menh$Var <- factor(menh$Var,levels = c("Piscivore Fall",
                                                   "Piscivore Spring",
                                                    "Benthivore Fall",
                                                    "Benthivore Spring",
                                                    "Planktivore Fall",
                                                    "Planktivore Spring",
                                                    "Benthos Fall",
                                                    "Benthos Spring"))
menh %>% 
  ggplot(aes(x = Time, y = Value, color = Var)) +
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  # geom_gls(aes(x = Time, y = Value,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Biomass (kg tow"^-1*")")) +
  ggtitle("ME/NH Inshore BTS") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

```

Fall offshore benthivore levels remain high in the Gulf of Maine (Fig. \ref{fig:gom-biomass-ne}), however, the New Hampshire/Maine survey shows a recent decline (Fig. \ref{fig:menh-survey}). Fall offshore planktivore levels returned towards the time series mean in the Gulf of Maine after two high years.

All fall aggregate groups on Georges Bank are at or below their time series mean for the offshore survey (Fig. \ref{fig:gb-biomass-ne}). Spring benthos biomass levels remain high on Georges Bank, and show significant increases over the long-term.

The proportion of NEFMC managed benthivore species (righteye flounders, haddock) has declined over time in Mid-Atlantic waters according to bottom trawl surveys (Fig. \ref{fig:NEFMC-in-MAB}), while the proportion of MAFMC managed planktivore (squids, mackerel and butterfish) species has been increasing in New England waters in both surveys and landings (Fig. \ref{fig:MAFMC-in-NE}, Fig. \ref{fig:comm-landings-ne}). 

```{r NEFMC-in-MAB, fig.width = 7, fig.asp = 0.35, fig.cap = "New England-managed survey proportion of MAB benthivores."}

nefmc_ma <- nefsc_survey_disaggregated %>% 
  # distinct() %>% 
  filter(EPU %in% c("MAB"),
         Management == "NEFMC",
         !str_detect(`Feeding guild`,"Other")) %>% 
  group_by(EPU, `Feeding guild`, Season, Time) %>% 
  dplyr::summarise(Value = sum(Proportion,na.rm = T)) %>% #IMPORTANT: Turn zeros to NA before taking mean
  mutate(Value = ifelse(Value == 0, NA, Value)) %>% #Turn zeros to NA
  unite(.,Var,c("Feeding guild","Season"), sep = " ") %>% 
  group_by(EPU,Var, .drop = FALSE) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  filter(str_detect(Var,"Benthivore")) %>% 
  ungroup() %>% 
  mutate(Var = paste(str_to_title(str_extract(Var, "fall|spring")),
         "survey"))

mab_nefmc_props <- nefmc_ma %>% 
 ggplot(aes(x = Time, y = Value, group = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  # scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  ggtitle("NEFMC benthivores in the Mid-Atlantic")+
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Proportion of MAB survey")) +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))



mab_nefmc_props

```

```{r MAFMC-in-NE, fig.width = 7, fig.asp = .7, fig.cap = "Mid-Atlantic-managed survey proportion of GOM and GB planktivores."}

mafmc_ne <- nefsc_survey_disaggregated %>% 
  distinct() %>% 
  filter(EPU %in% c("GOM","GB"),
         Management == "MAFMC",
         !str_detect(`Feeding guild`,"Other")) %>% 
  group_by(EPU, `Feeding guild`, Season, Time) %>% 
  dplyr::summarise(Value = sum(Proportion,na.rm = T)) %>% #IMPORTANT: Turn zeros to NA before taking mean
  mutate(Value = ifelse(Value == 0, NA, Value)) %>% #Turn zeros to NA
  unite(.,Var,c("Feeding guild","Season"), sep = " ") %>% 
  group_by(EPU,Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  filter(str_detect(Var,"Planktivore")) %>% 
  ungroup() %>% 
  mutate(Var = paste(str_to_title(str_extract(Var, "fall|spring")),
         "survey"))

gom_mafmc_props <- mafmc_ne %>% 
  filter(EPU == "GOM") %>% 
 ggplot(aes(x = Time, y = Value, group = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  # scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  ggtitle("MAFMC planktivores in Gulf of Maine")+
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab(expression("Proportion of GOM survey")) +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))

gb_mafmc_props <- mafmc_ne %>% 
  filter(EPU == "GB") %>% 
ggplot(aes(x = Time, y = Value, group = Var)) +
  
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max ,
      ymin = -Inf, ymax = Inf) +
  
  #Test for trend and add lines
  # geom_gls(aes(x = Time, y = Value,
  #              color = Var),
  #            alpha = trend.alpha, size = trend.size) +
  
  #Add time series
  geom_line(size = lwd-0.5) +
  geom_point(size = pcex-0.5) +
  # scale_color_manual(values = series.col, aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline,
                 group = Var),
             size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+

  #Facet 
  facet_wrap(Var~.,scales = "free_y", ncol = 2) +
  ggtitle("MAFMC planktivores on Georges Bank")+
  #Axis and theme
  scale_x_continuous(breaks = seq(1965, 2015, by = 10), expand = c(0.01, 0.01)) +
  ylab("Proportion of GB survey") +
  theme_facet()+
  theme(strip.text=element_text(hjust=0))


gom_mafmc_props + gb_mafmc_props + plot_layout(ncol = 1)

```

Other observations corroborate these survey trends. For example, butterfish have been observed in Gulf of Maine common tern fledgling diets between 2009-2011 and again in 2018 (Fig. \ref{fig:map-and-prey}b). The downward trend in recreational species diversity in the Mid-Atlantic (see Mid-Atlantic report) contrasts with an increase in recreational species diversity over time in New England (Fig. \ref{fig:rec-div}), although it is unclear to what extent this result is due to the aggregation of SAFMC species in the indicator itself. As temperature and ocean circulation indicators trend toward extremes (next section), fishery management will likely face continued changes in species distribution.

## Fish condition (coastwide, NEFMC managed stocks)
Fish condition is measured as the weight at a given length relative to the average - a measure of afatnessa, and a factor that influences fecundity. This information is from fall NEFSC bottom trawl surveys. Overall, condition factor has improved for many New England species since 2012, similar to overall high condition prior to 2000, and in contrast to overall lower condition between 2001-2010 (Fig. \ref{fig:ne-cf}). The timing of these shifts is similar to shifts in the small-large zooplankton indicator (Fig. \ref{fig:NE-sli}). Condition factor for some NEFMC managed species (red hake, GOM haddock, ocean pout, spiny dogfish, thorny skates, and components of winter, yellowtail and windowpane flounder stocks) was high in 2018. 
 

```{r ne-cf, fig.cap = "Condition factor for NEFMC managed species.", out.width = '\\textwidth'}

knitr::include_graphics(file.path(image.dir, "NEFMC_Fish_Condition_2019.jpg"))

```


## Larval diversity (GOM and GB)
Fluctuations in larval diversity from NEFSC ECOMON and bottom trawl surveys reflect changing dominance of forage fish, hake, and haddock. GOM larval diversity has been difficult to track due to poor recent ECOMON survey coverage in the winter (Fig. \ref{fig:gom-larval-div}). GB spring larval diversity and richness were relatively low in 2017 (the most recent year with adequate coverage) due to high larval abundance of haddock and sand lance (Fig. \ref{fig:gb-larval-div}). 

```{r gom-larval-div, fig.cap = "Larval diversity indices from ECOMON surveys in the Gulf of Maine.", fig.width = 8, fig.asp = .5}
gom_larv_div <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GOM",
         str_detect(Var, "Ich Shannon")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GOM larval diversity") +
  ylab("Shannon Diversity") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

gom_spec_rich <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GOM",
         str_detect(Var, "Species Caught")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GOM larval species richness") +
  ylab("Species richness") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

 gom_larv_div + gom_spec_rich + plot_layout(ncol = 1)

```

```{r gb-larval-div, fig.cap = "Larval diversity indices from ECOMON surveys on Georges Bank.", fig.width = 8, fig.asp = .5}
gb_larv_div <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GB",
         str_detect(Var, "Ich Shannon")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GB larval diversity") +
  ylab("Shannon Diversity") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

gb_spec_rich <- ecodata::ichthyo_diversity %>%
  filter(EPU == "GB",
         str_detect(Var, "Species Caught")) %>%
  mutate(Var = word(Var,1)) %>% 
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T)) %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
  geom_line() +
  geom_point() +
       annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  ggtitle("GB larval species richness") +
  ylab("Species richness") +
  facet_wrap(Var~., ncol = 2, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

 gb_larv_div + gb_spec_rich + plot_layout(ncol = 1)
```

Investigations are underway to evaluate changes in timing of spawning for managed fish species. Preliminary work with New England flatfishes suggests that some inshore stocks are spawning earlier as temperatures increase. There are implications for changes in spawning timing for fish condition and for larval survival as match or mismatch with zooplankton food sources changes (next section).  

\newpage

# Habitat Quality and Ecosystem Productivity

Productivity of harvested fish and protected species, and therefore sustainability of fisheries, depends on adequate habitat. Habitat encompasses physical, chemical, and biological factors, including biological productivity at the base of the food web. Many harvested and protected species on the Northeast US shelf occupy several distinct habitats throughout their life cycle, including estuaries, nearshore coastal, and offshore environments. The indicators in this section provide information on the changing conditions encountered by managed species in different seasons and across habitats, which may explain observed changes in species distribution and productivity. Ultimately, a better understanding of these ecological drivers may permit proactive management in a changing system. 

Ocean temperatures in coastal and offshore habitats are at or near unprecedented levels, accompanied by alterations in ocean circulation patterns. Observed changes at the base of the food web, including timing of production and plankton community composition, affect productivity of protected and managed species in ways we do not yet fully understand. 


## Ocean circulation and surface temperature (coastwide)
The position of the northern edge of the Gulf Stream has moved to the north since the late 1950s, with an increasing rate since 2009 (Fig. \ref{fig:GSI}). The most northerly positions ever recorded were observed over the most recent 2014-2017 period. A more northerly Gulf Stream position is associated with warmer ocean temperature on the Northeast US shelf [@zhang_role_2007], a higher proportion of Atlantic Temperate Slope Water entering the GOM through the Northeast Channel, and increased sea surface height along the U.S. east coast [@goddard_extreme_2015]. 

```{r GSI, fig.width = 4, fig.asp = 0.45, fig.cap = "Index representing the north wall of the Gulf Stream. Positive values represent a more northerly Gulf Stream position."}
gsi %>% 
  mutate(Year = floor(Time)) %>% 
  group_by(Year) %>% 
  dplyr::summarise(Value = mean(Value)) %>% 
  mutate(hline = mean(Value)) %>% 
  dplyr::rename(Time = Year) %>% 
  ggplot(aes(x = Time, y = Value)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Gulf Stream position anomaly") +
  ggtitle("Gulf Stream Index") +
    scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_ts() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
```


Globally, 2018 was the 4th warmest year on record and the last four years were the warmest on record. Since the 1860'??s, the Northeast US shelf sea surface temperature (SST) has exhibited an overall warming trend, with the past decade measuring well above the long term average (and the trendline; Fig. \ref{fig:long-term-sst}).

```{r long-term-sst, fig.width = 8, fig.asp = 0.25, fig.cap = "Average annual sea surface temperature (SST) over the Northeast US Shelf"}
lt_sst <- ecodata::long_term_sst %>% 
  mutate(hline = mean(Value))

lt_sst %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Temperature (C)") +
  ggtitle("Long-term SST") +
    scale_x_continuous(expand = c(0.01, 0.01), breaks = seq(1840,2010,20))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
```


## Ocean circulation and temperature (GOM and GB)
The changing position of the Gulf Stream north wall described above directly influences oceanic conditions in the GOM.  Since the mid-2000'??s, the warmer, saltier shelf slope water associated with the Gulf Stream has dominated the input into the GOM at the Northeast Channel, with 2017 having 99% warm slope water (Fig. \ref{fig:wsw-prop}), the highest estimated in the time series. The changing proportions of source water affect the temperature, salinity and nutrient inputs to the system. 

```{r wsw-prop, fig.width=5, fig.asp = 0.45, fig.cap = "Proportion of warm slope water (WSW) and Labrador slope water (LSLW) entering the GOM through the Northeast Channel."}

sw.df <- slopewater %>% 
  mutate(Var, Var = plyr::mapvalues(Var, from = c("WSW proportion ne channel",
                                                  "LSLW proportion ne channel"),
                                    to = c("WSW","LSLW"))) %>% 
  dplyr::rename(Origin  = Var) %>% 
  group_by(Origin) %>% 
  mutate(hline = mean(Value)) 

sw.df$Origin <- factor(sw.df$Origin, levels = c("WSW","LSLW"))

ggplot(data = sw.df) +
  geom_line(aes(x = Time, y = Value, color = Origin))+
  geom_point(aes(x = Time, y = Value, color = Origin)) +
  ylab("Percent of Total Slopewater") +
  ggtitle("Slopewater Proportions in NE Channel")+
    scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline,
                     color = Origin),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_ts() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))

```

Concurrently, annual surface and bottom temperatures (Fig. \ref{fig:NE-bot-temp}) in the GOM and GB have trended warmer since the early 1980s, and seasonal surface temperatures have trended warmer in spring, summer, and fall. The 2018 summer sea surface temperatures were the highest on record in the GOM, although temperatures during the other seasons were near or slightly below average (Figs. \ref{fig:NE-SST-anom-series}, \ref{fig:NE-SST-insitu}). 
  
```{r NE-bot-temp, fig.width = 8, fig.asp = .25, fig.cap = "GOM and GB annual bottom temperature anomalies."}
bot_temp_insitu_gom <- oceantemp_insitu %>%
  filter(EPU == "GOM",
         Var == "bottom temp anomaly in situ") %>% 
  mutate(hline = 0) %>% 
    ggplot()+ #plot
     annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value), size = 1) +
  ylab("Temp. Anomaly (C)") +
  ggtitle("GOM Bottom Temperature Anomaly") +
  scale_x_continuous(expand = c(0.01, 0.01)) +
    geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() +
  theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))


bot_temp_insitu_gb <- oceantemp_insitu %>%
  filter(EPU == "GB",
         Var == "bottom temp anomaly in situ") %>%
   mutate(hline = 0) %>% 
    ggplot()+ #plot
     annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Value)) +
  geom_gls(aes(x = Time, y = Value)) +
  geom_point(aes(x = Time, y = Value), size = 1) +
  ylab("Temp. Anomaly (C)") +
  ggtitle("GB Bottom Temperature Anomaly") +
  scale_x_continuous(expand = c(0.01, 0.01)) +
    geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  theme_ts() +
  theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))



bot_temp_insitu_gom +
 bot_temp_insitu_gb + plot_layout(nrow = 1)
  #plot_layout(ncol =  1) &
  #theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))

```

```{r NE-SST-anom-series, fig.width = 8, fig.asp = 0.45, fig.cap = "GOM and GB seasonal sea surface temperature anomaly time series."}
ne_anom <- seasonal_oisst_anom %>% 
  filter(EPU %in% c("GOM","GB")) %>% 
    mutate(hline = 0,
           Var = str_to_title(str_extract(Var,"winter|spring|summer|fall")))
ne_anom$Var <- factor(ne_anom$Var, levels= c("Winter","Spring","Summer","Fall"))

ne_anom_plt <- ggplot(data = ne_anom, 
       aes(x = Time, y = Value, color = EPU, group = EPU))+ #plot
     annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line()+
  geom_point()+
  ylim(-2,3)+
  geom_gls() +
  ylab("SST Anomaly (C)") +
  ggtitle("Gulf of Maine & Georges Bank SST Anomaly") +
    scale_color_manual(values = c("black","indianred"))+
    scale_x_continuous(expand = c(0.01, 0.01)) +
    geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  facet_wrap(Var ~., ncol = 2, scales = "free_y")+
  theme_facet() +
  theme(strip.text=element_text(hjust=0),
        plot.title = element_text(size = 12))
ne_anom_plt
```

```{r NE-SST-insitu, fig.width=8, fig.height = 5, fig.cap = "GOM and GB 2018 seasonal sea surface temperature spatial anomalies."}
#EPU shapefile
epu_sf_ne <- ecodata::epu_sf %>% 
  filter(EPU %in% c("GOM","GB"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -73
xmax = -65
ymin = 39.5
ymax = 44.5
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
sst <- seasonal_oisst_anom_gridded 

sst$Season <- factor(sst$Season, levels = c("Winter",
                                            "Spring",
                                            "Summer",
                                            "Fall"))
sst_map <- 
  ggplot() +
  geom_tile(data = sst, aes(x = Longitude, y = Latitude,fill = Value)) +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_sf_ne, fill = "transparent", size = map.lwd) +
  scale_fill_gradient2(name = "Temp.\nAnomaly (C)",
                       low = scales::muted("blue"),
                       mid = "white",
                       high = scales::muted("red"),
                       limits = c(-5,5)) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  facet_wrap(Season~.) +
  theme_map() +
  ggtitle("SST anomaly (2018)") +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))


sst_map 

```


## Primary production (GOM and GB)
Phytoplankton primary production is a function of biomass, light, and temperature, and sets the overall level of potential fish and fishery productivity in an ecosystem (Fig. \ref{fig:prod-potential}). 

```{r prod-potential, fig.cap = "Simplified representation of the pathways linking primary production and environmental driver throughout a fishery ecosystem. The important societal benefits that derive from sustainable fisheries depend directly on a sequence of events starting at the base of the food web. The production of fish and shellfish available for harvest by the fisheries follows pathways of energy flow from phytoplankton and zooplankton to different parts of the food web. The production at each component further depends on the effect of a host of environmental drivers including temperature, salinity, and other factors.", out.width='\\linewidth'}

knitr::include_graphics(file.path(image.dir, "SOE_Network_Diagram.png"))
```

There is a trend of increasing primary production in both New England systems, primarily driven by increased summer production, which is due to warmer temperatures and increased bacterial remineralization and nutrient recycling (Fig. \ref{fig:NE-PP-OCCI}). This increased productivity is most likely from smaller-celled species that contribute less to fish production compared to larger phytoplankton. The 2018 winter-spring phytoplankton bloom, comprised primarily of larger diatoms, was above average in both the GOM and GB, however the timing in the GB was earlier than normal (Fig. \ref{fig:NE-chl-weekly}). Summer biomass was below average throughout most of the region, while the fall bloom was below average nearshore in the GOM and slightly above average offshore and in parts of GB.

```{r NE-PP-OCCI, fig.width=8, fig.height = 8, fig.cap = "Monthly primary production trends show the annual cycle (i.e. the peak during the summer months) and the changes over time for each month."}
out_pp <- ecodata::chl_pp %>% 
  filter(EPU %in% c("GOM","GB"),
         str_detect(Var, "MONTHLY_PPD_MEDIAN")) %>% 
  separate(.,Time, into = c("Year","Month"), sep = 4) %>% 
    mutate(Month = plyr::mapvalues(Month, from = c("01","02","03","04","05","06",
                                                   "07","08","09","10","11","12"),
                                   to = c(month.abb))) %>% 
  group_by(EPU, Month) %>% 
  mutate(hline = mean(Value))
out_pp$Month <- factor(out_pp$Month, levels = month.abb)

pp_cci_gom <- out_pp %>% 
  filter(EPU == "GOM") %>% 
 ggplot() +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "Time", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
    facet_wrap(Month~., ncol = 6) +
    ggtitle("GOM Monthly median PPD") +
    ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
        geom_hline(aes(yintercept = hline,
                     group = Month),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(1, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
 
 pp_cci_gb <-out_pp %>% 
  filter(EPU == "GB") %>% 
 ggplot() +
   # geom_gls(aes(x = Year, y = Value, group = Month))+
    geom_point(aes(x = Year, y = Value, group = Month)) +
    geom_line(aes(x = Year, y = Value, group = Month)) +
    scale_x_discrete(name = "Time", breaks = seq(min(out_pp$Year),max(out_pp$Year),10)) +  
    facet_wrap(Month~., ncol = 6) +
    ggtitle("GB Monthly median PPD") +
    ylab(expression("PP (gC m"^-2*" d"^-1*")")) +
        geom_hline(aes(yintercept = hline,
                     group = Month),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
    theme_facet() +
    theme(axis.text.x = element_text(angle=45, hjust = 1),
          panel.spacing = unit(1, "lines"),
          plot.margin = unit(c(0.1, 0, 0, 0), "cm"))
 
 pp_cci_gom + pp_cci_gb + plot_layout(ncol = 1)
```

```{r NE-chl-weekly, fig.width = 8, fig.asp = 0.25, fig.cap = "Weekly chlorophyll concentrations and primary productivity for 2018 in Gulf of Maine and Georges Bank are shown by the colored lines in the above figures. The long-term mean is shown in black and shading indicates +/- 1 sample SD."}

interp_chl_pp <- function(epu, year = 2018, Variable){
  out <- ecodata::chl_pp %>% 
    filter(str_detect(Var,Variable),
           EPU == epu) %>% 
    separate(.,Time, c("Year","Week"),sep = 4) %>% 
    filter(Year == year) %>% 
    group_by(EPU) %>% 
    mutate(Time = 1:length(Year))
  
  ltm_out <- ecodata::chl_pp %>% 
    filter(str_detect(Var,Variable),
           EPU == epu) %>% 
    separate(.,Time, c("Year","Week"),sep = 4) %>% 
    group_by(Week) %>% 
    dplyr::summarise(LTM = mean(Value, na.rm = T),
                     SD = sd(Value, na.rm = T)) %>% 
    mutate(Time = 1:length(Week),
           sd.low = LTM - SD,
           sd.high = LTM + SD) %>% 
    left_join(.,out, by = c("Time")) %>% 
    mutate(status = ifelse(Value < sd.high & Value > sd.low, "near_mean",
                           ifelse(Value > sd.high, "high",
                                  ifelse(Value < sd.low,"low",NA))),
           group = "PLOT")
  
  return(ltm_out)
}

GB_chl_weekly <- interp_chl_pp(epu = "GB", year = 2018,Variable = "WEEKLY_CHLOR_A_MEDIAN")

GB_chl <- ggplot(data = GB_chl_weekly) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = pmax(sd.low,0), ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggtitle(expression("GB chlorophyll"~italic(a)~"")) +
  guides(color = F) +
  xlab("")+
  ylab("") +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()


GOM_chl_weekly <- interp_chl_pp(epu = "GOM", year = 2018,Variable = "WEEKLY_CHLOR_A_MEDIAN")

GOM_chl <- ggplot(data = GOM_chl_weekly) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = sd.low, ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggtitle(expression("GOM chlorophyll"~italic(a)~"")) +
  guides(color = F) +
  xlab("")+
  ylab(expression("CHL (mg m"^-3*")")) +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()

GB_ppd_weekly <- interp_chl_pp(epu = "GB",  year = 2018,Variable = "WEEKLY_PPD_MEDIAN")

GB_ppd <- ggplot(data = GB_ppd_weekly) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = pmax(sd.low,0), ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  ggtitle(expression("GB primary production")) +
  guides(color = F) +
  xlab("")+
  ylab("") +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()


GOM_ppd_weekly <- interp_chl_pp(epu = "GOM",  year = 2018,Variable = "WEEKLY_PPD_MEDIAN")

GOM_ppd <- ggplot(data = GOM_ppd_weekly) +
  geom_line(aes(x = Time, y = LTM)) +
  geom_ribbon(aes(x = Time, ymin = sd.low, ymax = sd.high), 
              alpha = 0.1,
              fill = "grey1") +
  geom_line(aes(x = Time, y = Value),
            size = 1,color = "#33a02c") +
  guides(color = F) +
  xlab("")+
  ggtitle(expression("GOM primary production")) +
  scale_x_continuous(breaks = seq(1,52,10),
                   labels = c("Jan.","Mar.","May","July","Oct.","Dec."),
                   expand = c(0.01,0.01)) +
  ylab((expression("PP (gC m"^-2*" d"^-1*")"))) +
  scale_color_manual(values = c("#ef8a62","#2c7fb8","#a1d99b"))+
  theme_ts()


#GOM_chl + GB_chl + GOM_ppd + GB_ppd + plot_layout(ncol = 2) & theme(plot.margin = margin(r = 0.5))
GOM_chl + GB_chl + plot_layout(ncol = 2) & theme(plot.margin = margin(r = 0.5))
```


## Zooplankton (GOM and GB)
The most abundant zooplankton species in the GOM are *Calanus finmarchicus* (an important prey for larval fish and the north Atlantic right whale),  *Centropages typicus*, and *Psuedocalanus* spp. [@morse_distinct_2017].  *Calanus finmarchicus* had low overall abundance in the GOM from 2009-2014, with higher than normal abundance in 2015-2016 and a return to normal levels in 2017 (Fig. \ref{fig:NE-zoo-abund}). On GB, *Calanus finmarchicus* annual abundance has been low continually since 2009. *Centropages typicus* has had higher than normal abundance from 2012-2017 on both GB and GOM. *Pseudocalanus* abundance trends were similar to *Calanus* in recent years, with low abundance from 2001-2014 in the GOM and higher than normal 2015-2016, but normal abundance in 2017. On GB, *Pseudocalanus* abundance has a significant long term decline (Fig. \ref{fig:NE-zoo-abund}) with an increase to the long term mean in 2016-2017.

```{r NE-zoo-abund, fig.width = 8, fig.asp = .65, fig.cap = "Abundance anomaly time series for key zooplankton species found in the GOM and GB."}
zoo_abund <- ecodata::zoo_anom_sli %>% 
  filter(EPU %in% c("GOM","GB"),
         !str_detect(Var, "small-large")) %>% 
  mutate(hline = 0,
         Var = str_to_title(str_remove(Var, "anomaly"))) 

gom_zoo_abund <- zoo_abund %>% 
  filter(EPU == "GOM") %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Abundance anomaly") +
  ggtitle("GOM Zooplankton abundance anomaly") +
  facet_wrap(Var~., ncol = 3, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))

gb_zoo_abund <- zoo_abund %>% 
  filter(EPU == "GB") %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_gls() +
  geom_line() +
  geom_point() +
  ylab("Abundance anomaly") +
  ggtitle("GB Zooplankton abundance anomaly") +
  facet_wrap(Var~., ncol = 3, scales = "free_y") +
  scale_x_continuous(expand = c(0.01, 0.01))+
      geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0,
                                face = "italic"))
  
gom_zoo_abund + gb_zoo_abund + plot_layout(ncol = 1)

```

Changes in the abundance of the larger *Calanus finmarchicus* are also reflected in the size distribution of the copepods. The small-large copepod index is a measure of the relative size composition of the dominant copepod taxa. During the 1990s and early 2000s, the positive index was driven by high relative abundance of smaller bodied copepods and a lower relative abundance of *Calanus finmarchicus*. This period also corresponds with regime shifts to lower fish recruitment [@perretti_regime_2017]. The current trend in the index suggests an increase in the relative abundance of smaller bodied copepods (Fig. \ref{fig:NE-sli}).

```{r NE-sli, fig.width = 8, fig.asp = 0.45, fig.cap = "GOM and GB small-large zooplankton index and the annual primary production anomaly."}
sli <- ecodata::zoo_anom_sli %>% 
  filter(EPU %in% c("GOM","GB"),
         str_detect(Var, "small-large")) %>% 
  mutate(hline = 0) 
sli$EPU <- factor(sli$EPU, levels = c("GOM","GB"))

pp_anom <- ecodata::chl_pp %>% 
  filter(str_detect(Var, "ANNUAL_PPD_RATIO_ANOMALY"),
         EPU %in% c("GOM","GB")) %>% 
  mutate(hline = 1,
         Time = as.numeric(as.character(Time)),
         Var = "ANNUAL_PPD_RATIO_ANOMALY")
pp_anom$EPU <- factor(pp_anom$EPU, levels = c("GOM","GB"))

sli_plt <- sli %>% 
  ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  guides(color = F) +
  facet_wrap(EPU~.,ncol = 2)+
  xlab("")+
  ylab("Small-large abundance") +
  ggtitle("Small-large copepod abundance") +
    scale_x_continuous(expand = c(0.01, 0.01), limits = c(1988, 2018))+
      geom_hline(aes(yintercept = hline,
                     group = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))

pp_anom_plt <- pp_anom %>% 
    ggplot(aes(x = Time, y = Value, group = Var)) +
         annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  guides(color = F) +
  ylab("Anomaly ratio") +
  facet_wrap(EPU~.,ncol = 2)+
  ggtitle("Primary production anomaly ratio") +
    scale_x_continuous(expand = c(0.01, 0.01), limits = c(1988, 2018))+
    scale_y_continuous(limits = c(0.6,1.4)) +
      geom_hline(aes(yintercept = hline,
                     group = Var),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty)+
  theme_facet() +
  theme(strip.text=element_text(hjust=0))


sli_plt + pp_anom_plt + plot_layout(ncol = 1) & theme(plot.margin = margin(t = 0))
```


Changes in primary productivity, phytoplankton and zooplankton composition and abundance affect the food web and may be related to observed changes in fish condition, recruitment patterns, and forage fish energy content. However, more research and analyses are needed to directly link these connections. Any attempt to predict how the ecosystem will respond to changes in climate and fishing patterns ultimately will depend on understanding these connections. Our objective is to shed light on these fundamental issues and to document changes affecting human communities and the fishery ecosystem on which we depend.  

# Contributors

**Editors** (NOAA NMFS Northeast Fisheries Science Center, NEFSC): Sarah Gaichas, Sean Hardison, Scott Large, Sean Lucey

**Contributors** (NEFSC unless otherwise noted): Lisa Calvo (Rutgers), Matthew Camisa (MA Division of Marine Fisheries), Patricia Clay, Lisa Colburn, Geret DePiper, Michael Fogarty, Paula Fratantoni, Kevin Friedland, Sarah Gaichas, James Gartland (Virginia Institute of Marine Science), Heather Haas, Sean Hardison, Kimberly Hyde, Terry Joyce (Woods Hole Oceanographic Institute), John Kosik, Steve Kress and Don Lyons (National Audubon Societyas Seabird Restoration Program), Sean Lucey, Chris Melrose, Ryan Morse, Kimberly Murray, Chris Orphanides, Richard Pace, Charles Perretti, Karl Roscher (Maryland Department of Natural Resources), Vincent Saba, Laurel Smith, Mark Terceiro, John Walden, Harvey Walsh, Mark Wuenschel, and Qian Zhang (Unversity of Maryland and US EPA Chesapeake Bay Program).  

\newpage 

# Document Orientation

The figure format is illustrated in Fig \ref{fig:docformat}a. Trend lines are shown when slope is significantly different from 0 at the p < 0.05 level. An orange line signifies an overall positive trend, and purple signifies a negative trend. To minimize bias introduced by small sample size, no trend is fit for < 30 year time series. Dashed lines represent mean values of time series unless the indicator is an anomaly, in which case the dashed line is equal to 0. Shaded regions indicate the past ten years. If there are no new data for 2018, the shaded region will still cover this time period. The spatial scale of indicators is either coastwide, New England states (Maine, New Hampshire, Massachusetts, Rhode Island, Connecticut), or at the Gulf of Maine (GOM) and Georges Bank (GB) Ecosystem Production Unit (EPU, Fig. \ref{fig:docformat}b) level.

```{r docformat, fig.cap = "Document orientation. a. Key to figures. b.The Northeast Large Marine Ecosystem.",  fig.width = 8, fig.height = 2.5}
#fig.subcap= c(aKey to figures.a, aThe Northeast Large Marine Ecosystem.a), out.width = a.49\\linewidtha, fig.show="hold" 
# FIgure orientation subfigure
m <- 0.1
x <- 1985:2018
y <-  m*x + rnorm(30, sd = 0.35)

data <- data.frame(x = x,
                  y = y)

#Define constants for figure plot
x.shade.max <- max(x)
x.shade.min <- x.shade.max - 9 
hline = mean(y)

#Plot series with trend 
psample <- ggplot2::ggplot(data = data,aes(x = x, y = y)) +
  #Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_point(size = pcex) +
  scale_color_manual(aesthetics = "color")+
  guides(color = FALSE) +
  geom_hline(aes(yintercept = hline),
              size = hline.size,
             alpha = hline.alpha,
             linetype = hline.lty)+
  geom_line() +
  geom_gls() +
  scale_y_continuous(labels = function(l){trans = l / 1000})+
  scale_x_continuous(breaks = seq(1985, 2015, by = 5), expand = c(0.01, 0.01)) +
  ylab(expression("Invented Index, 10"^3*"widgets")) +
  xlab("Time") +
  labs(tag = "a")  +
  theme_ts()


# EPU map subfigure
# Set lat/lon window for map
xmin = -78
xmax = -65
ymin = 36
ymax = 45
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)

#CRS
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

#Specify data frame with lat/lon locations for labels
epu_labels <- data.frame(EPU = c("Mid-Atlantic\n Bight",
                                 "Gulf of Maine",
                                 "Georges Bank"),
                         latitude = c(40,42.85,41),
                         longitude = c(-72.7,-69,-68.5))

#Map of NE LME
epumap <- ggplot() +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_sf, fill = "transparent", size = map.lwd) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  geom_text(data = epu_labels, aes(x = longitude,
                                    y = latitude,
                                    label = EPU),
            size = 1.7)+
  theme_map() +
  scale_x_continuous(breaks = seq(-78, -65, by = 4), expand = c(0.01, 0.01)) +
  xlab("Longitude") +
  ylab("Latitude") +
  labs(tag = "b")

psample + plot_spacer() + epumap + plot_layout(ncol = 3, widths=c(3,.5,4.5))

```

Fish and invertebrates are aggregated into similar feeding categories (Table \ref{tab:species-groupings}) to evaluate ecosystem level trends in predators and prey. 

```{r species-groupings, warning=F}

# new table with all species listed by management entity
df <- ecodata::species_groupings %>%
  dplyr::select(SOE_18, COMNAME, Fed_Managed) %>%
  filter(SOE_18 != "Other") %>%
  distinct() %>%
  group_by(SOE_18, Fed_Managed) %>%
  summarize_all(funs(paste(na.omit(.), collapse = ", "))) %>%
  spread(Fed_Managed, COMNAME) %>%
  arrange(factor(SOE_18, levels = c("Apex Predator", "Piscivore", "Planktivore", "Benthivore", "Benthos")))
df<-df[-6,c(1,4,3,5,6)] %>%
  mutate_all(tolower)


knitr::kable(df, booktabs = TRUE, caption = 'Feeding guilds and management bodies.', 
             col.names = c("Guild", "MAFMC", "Joint", "NEFMC", "State or Other")) %>%
  kable_styling(font_size=10, latex_options=c("repeat_header", "scale_down", "hold_position")) %>%
  row_spec(0,bold=TRUE) %>%
  column_spec(1, width="2cm") %>%
  column_spec(2, width="4cm") %>%
  column_spec(3, width="2cm") %>%
  column_spec(4, width="5cm") %>%
  column_spec(5, width="6cm") %>%
  #column_spec(3, width="7.5cm") #%>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle")

```

\newpage 

# References
